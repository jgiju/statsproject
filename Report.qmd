title: "Data Analysis Report - Analyzing the Impact of GDP, Time, and equatorial location on Life Expectancy"
author: "Elizabeth Yirava, Joanna Giju, Nicholas Rohrs, Huiyan Ni"
date: "04/17/2024"
format:
  pdf:
    documentclass: article
    geometry:
      - margin=1in
    fontsize: 12pt
execute:
  echo: false
  warning: false
  message: false
bibliography: references.bib
---

```{r}
#| label: setup

## Good practice to include libraries and functions you will need in a chunk
## at the beginning of your file
library(jtools)
library(patchwork)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(broom)
library(here)
## functions
logit <- function(x) log(x/(1 - x))
invlogit <- function(x) exp(x)/(1 + exp(x))

## This sets the gpplot theme to white for all plots
## the option `base_size` sets the base font size for all plots
theme_set(
    theme_bw(base_size = 8)
)
```

# Abstract

In this project, the overarching question was what significant factors are playing a role in the average life expectancies of a country. To dive further, studies were done to display the influence of the Gross Domestic Product (GDP), year, and distance from equator, on the proportion of average life expectancies above 62 across various nations. To do this, we manipulated the dataset to include a binary variable representing whether a specific data point had an average life expectancy above 62. Once this was done, we first focused on analyzing the statistical trends between economic strength and the overall average life expectancy of a nation. In effort to do this, we focused on the Top 7 GDP countries to display the economically strongest players across the globe over a given period and created a binomial regression model displaying the relationship between economic strength, time, and life expectancy proportions. The study revealed a significant correlation between GDP and life expectancy displaying the higher GDP generally associated with longer life expectancies. Also, looking at the countries with significantly lower GDPs, we see the proportion of populations with expectancies above 62 are far less than countries with high GDPs which displays how important a nation’s economic position is on the population’s lifespan. Additionally, when focusing on the United States alone, a Bernoulli regression modeling displaying the country’s expectancy trends against time, (noting as health care, socio-economic factors, and overall lifestyle advancements increased), the proportion of average life expectancy above 62 also increased. Finally, contrasting countries based on distance from equator, the Bernoulli model shows countries located closer to the equator have a lower life expectancy which may be due to climate, environment, and disease. The study offers valuable insights on the impact of economic strength, lifestyle advancements, and environmental factors on life expectancies. 

# Introduction

Across the globe, it is apparent that most of the human population is living much longer than in the past. In 1900 the average life expectancy in the US was 32 years old and in 2021, the global average life expectancy was drastically doubled to over 71 (Dattani). This increase is predominately due to advancements in health care, economic growth, education, living conditions, and poverty reduction. Due to this significant shift in behavior, we decided to analyze a data set dedicated to life expectancy data dating back for more than a century. From this data set there are some key insights we are looking to find:
The change in the proportion of a country’s population whose average life expectancy is greater than 62 overtime when focusing on the 7 major worldwide economic players.
The change in the proportion of average life expectancies above 62 in the United States alone over the years.
Comparing the proportion of average life expectancies above 62 in countries near the equator vs far in effort to see the significance of climate/environmental factors on life expectancy.


# Data and Methods

Describe the data you used in your analysis, including the source, characteristics, and any pre-processing or cleaning steps you performed. 

The “life_expectancy.csv” includes the most aggregate measures, and the variables are as follows: the country or region entity, the entity code, and the year and the life expectancy at birth for each cohort. The data includes 20,755 observations total, spanning 239 countries and 313 years.In the TidyTuesday post, additional context for the data source explains that “The data this week comes the Our World in Data Life Expectancy report, specifically the figures in the key insights section” (Rfordatascience, 2023). The Our World in Data page mentions that life expectancy changes are greatly impacted by “the large reduction in child mortality”, along with “advances in medicine, public health, and living standards” (Dattani et al., 2023). The data collection process involved household surveys, historical estimates, and existing databases from countries around the world.
Characteristics: ?????
We added a binary variable 'Past 62' to represent whether or not the average life expectancy for the data point was above 62 or not. For the first insight, we filtered the data to only include the past 100 years and from the article, "The top 10 Largest economies in the world", by Forbes India, we filtered the data set to only include data points belonging to the top 7 GDP countries to display the economically strongest players. For the second insight, we decided to focus on the United States alone in the past century to analyze the impact of health care, socio-economic factors, and overall lifestyle advancements, on the proportion of life expectancies above 62. Finally for the third insight, we looked at the impact of the equatorial location on a country's life expectancy. 

```{r}
le <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-12-05/life_expectancy.csv')
le_different_ages <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-12-05/life_expectancy_different_ages.csv')

```

```{r}
working_dir <- here::here()

colnames(le)[4] <- "LifeExpectancy"

colnames(le_different_ages)[4:9] <- c("LifeExpectancy0", "LifeExpectancy10", "LifeExpectancy25","LifeExpectancy45", "LifeExpectancy65", "LifeExpectancy80")

```

```{r}
# Add a new column named 'Past62' indicating whether individuals are expected to live past 62
le$Past62 <- ifelse(le$LifeExpectancy > 62, 1, 0)

# Top 7 GDP countries to include
countries_to_include <- c("United States", "China", "Japan", "Germany", "India", "United Kingdom", "France")

# Filter the dataset to include only the specified countries
le_filtered <- le %>% filter(Entity %in% countries_to_include)
```

## INSIGHT 1- TOP 7 GDP COUNTRIES

We define as outcome the presence/absence of a population whose average life expectancy is above 62 for each country and denote the observed values as $y_i$ with $i = 1, \ldots, n$ with $n = 7$. Let $y_i = 1$ indicate average life expectancy $> 62$ and $0$ otherwise.  

We assume that each $y_i$ is a realization of a random variables $Y_i \sim \mbox{Bernoulli}(p_i)$ independently, and model an average life expectancy above 62 for each country using the following logistic regression:

 ---Idk about beta 8 this graph might just be for facotr variables or should we include time? 

$$
\begin{aligned}
  \mbox{logit}(p_i) = & \beta_0 + \\ 
                    & \beta_1 \times \text{I(Country == United States)}_i  \\
                   & \beta_2 \times \text{I(Country == China)}_i \\
                   & \beta_3 \times \text{I(Country == Germnay)}_i \\
                   & \beta_4 \times \text{I(Country == Japan)}_i \\
                   & \beta_5 \times \text{I(Country == India)}_i \\
                   & \beta_6 \times \text{I(Country == United Kingdom)}_i \\
                   & \beta_7 \times \text{I(Country == France)}_i \\
                   & \beta_8  \times \text{(Year)}_i
\end{aligned}
$$ {#eq-crab-model}
/////SHOULD THERE BE INDICATOR VARIABLE FOR YEAR

where $\mbox{I}()$ in Equation 1 indicates an indicator variable, taking value 1 when the condition is true and zero otherwise

## INSIGHT 2- United States over time Binomial THIS IS WRONG MODEL SET UP ->(N,P)

We define as outcome in the United states where the average life expectancy is above 62 at $year_i$ and denote the observed values as $y_i$ with $i = 1, \ldots, n$ with $n = 100$. Let $y_i = 1$ indicate average life expectancy $> 62$ and $0$ otherwise.  

We assume that each $y_i$ is a realization of a random variables $Y_i \sim \mbox{Bernoulli}(p_i)$ independently, and model an average life expectancy above 62 for each year using the following logistic regression:

## INSIGHT 3 - Countries close and far from equator


# Results

## Insight 1- THIS ENTIRE SECTION NEEDS TO BE FIXED- YEAR AND COUNTRY OR JUST YEAR OR JUST COUNTRY?? ALSO WHICH YR AGGREGATION- 5 OR 10?

```{r}
# Scatterplot of past62 vs year
# Picked >= 1910 because there aren't any countries with prop >0 until 1930

top_gdp_countries_5 <- le_filtered %>%
  mutate(Year = as.integer(Year %/% 5) * 5) %>%
  subset(Year >= 1900) %>%
  group_by(Year) %>%
  summarize(proportion_past_62 = mean(Past62))

ggplot(top_gdp_countries_5, aes(x = Year)) + 
  geom_point(aes(y = proportion_past_62)) +
  labs(title = "Proportion of population surviving to age 62 vs year", x = "Year", y= "Proportion") +
  theme_bw()

# With Color
my_colors <- c("red", "orange", "yellow", "green", "blue", "purple", "pink")
top_gdp_countries_5 <- le_filtered %>%
  mutate(Year = as.integer(Year %/% 5) * 5) %>%
  subset(Year >= 1900) %>%
  group_by(Entity, Year) %>%
  summarize(proportion_past_62 = mean(Past62))

ggplot(top_gdp_countries_5, aes(x = Year, y = proportion_past_62, color = Entity)) + 
  geom_point(position = position_jitter(width = 1, height = 0), size = 1) +
  labs(title = "Proportion of population surviving to age 62 vs year", x = "Year", y= "Proportion") +
  theme_bw()+
  scale_color_manual(values = my_colors)

```

```{r}
binomial_model_yr <- glm(proportion_past_62 ~ Decade, data = top_gdp_countries_10, family = binomial)
summary(binomial_model_yr)
anova_gdp <- anova(binomial_model_yr, test = "Chisq")
anova_gdp
```

```{r}
# Tried to change year to number of decades since 1900. I do not know if this is right but this did not help.
top_gdp_countries_10 <- top_gdp_countries_10 %>% mutate(Decade_Since_1900 = (Decade - 1900) / 10)

binomial_model_decade <- glm(proportion_past_62 ~ Decade_Since_1900, data = top_gdp_countries_10, family = binomial)

summary(binomial_model_decade)

anova_gdp <- anova(binomial_model_decade, test = "Chisq")
anova_gdp
```

Insight 2:

Had to change the target number to 40 because the life expectancy does not hit 62 until after the industrial revolution.

```{r}
# Filter the data for the years 1760-1840, but 62 is not reached in this time period.
filtered_data <- le_filtered %>%
  filter(Year >= 1760 & Year <= 1840)

proportion_data <- filtered_data %>%
  group_by(Year) %>%
  summarize(proportion_past_62 = mean(Past62))

model <- lm(proportion_past_62 ~ Year, data = proportion_data)

predictions <- data.frame(Year = seq(min(proportion_data$Year), max(proportion_data$Year), by = 1))
predictions$Predicted <- predict(model, newdata = predictions)

ggplot(proportion_data, aes(x = Year, y = proportion_past_62)) +
  geom_point() +
  labs(title = "Proportion of countries hitting 62 years vs year", x = "Year", y= "Proportion") +
  theme_bw()
```


```{r}
# Filter the data for the years 1760-1840, but changed target number to 40 which is reached in this period.

le_filtered$Past40 <- ifelse(le_filtered$LifeExpectancy > 40, 1, 0)

filtered_data <- le_filtered %>%
  filter(Year >= 1760 & Year <= 1840)

proportion_data <- filtered_data %>%
  group_by(Year) %>%
  summarize(proportion_past_40 = mean(Past40))

model <- lm(proportion_past_40 ~ Year, data = proportion_data)

predictions <- data.frame(Year = seq(min(proportion_data$Year), max(proportion_data$Year), by = 1))
predictions$Predicted <- predict(model, newdata = predictions)

ggplot(proportion_data, aes(x = Year, y = proportion_past_40)) +
  geom_point() +
  labs(title = "Proportion of countries hitting 40 years vs year", x = "Year", y= "Proportion") +
  theme_bw()
```

Since the shift from reaching the target age of 62 happens around 1945, I changed the time period to focus on.

```{r}
# Filtered the data for the years two decades before and after World War 2, which is around when 62 is reached.
filtered_data <- le_filtered %>%
  filter(Year >= 1920 & Year <= 1960)

proportion_data <- filtered_data %>%
  group_by(Year) %>%
  summarize(proportion_past_62 = mean(Past62))

model <- lm(proportion_past_62 ~ Year, data = proportion_data)

predictions <- data.frame(Year = seq(min(proportion_data$Year), max(proportion_data$Year), by = 1))
predictions$Predicted <- predict(model, newdata = predictions)

ggplot(proportion_data, aes(x = Year, y = proportion_past_62)) +
  geom_point() +
  labs(title = "Proportion of countries hitting 62 years vs year", x = "Year", y= "Proportion") +
  theme_bw()
```


