title: "Data Analysis Report - Analyzing the Impact of GDP, Time, and equatorial location on Life Expectancy"
author: "Elizabeth Yirava, Joanna Giju, Nicholas Rohrs"
date: "04/17/2024"
format:
  pdf:
    documentclass: article
    geometry:
      - margin=1in
    fontsize: 12pt
execute:
  echo: false
  warning: false
  message: false
bibliography: references.bib
---

```{r}
#| label: setup

## Good practice to include libraries and functions you will need in a chunk
## at the beginning of your file
library(jtools)
library(patchwork)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(broom)
library(here)
## functions
logit <- function(x) log(x/(1 - x))
invlogit <- function(x) exp(x)/(1 + exp(x))

## This sets the gpplot theme to white for all plots
## the option `base_size` sets the base font size for all plots
theme_set(
    theme_bw(base_size = 8)
)
```

# Abstract

In this project, the overarching question was what significant factors are playing a role in the average life expectancies of a country. To dive further, studies were done to display the influence of the Gross Domestic Product (GDP), year, and distance from equator, on the proportion of average life expectancies above 62 across various nations. To do this, we manipulated the dataset to include a binary variable representing whether a specific data point had an average life expectancy above 62. Once this was done, we first focused on analyzing the statistical trends between economic strength and the overall average life expectancy of a nation. In effort to do this, we focused on the Top 7 GDP countries to display the economically strongest players across the globe over a given period and created a binomial regression model displaying the relationship between economic strength, time, and life expectancy proportions. The study revealed a significant correlation between GDP and life expectancy displaying the higher GDP generally associated with longer life expectancies. Also, looking at the countries with significantly lower GDPs, we see the proportion of populations with expectancies above 62 are far less than countries with high GDPs which displays how important a nation’s economic position is on the population’s lifespan. Additionally, when focusing on the United States alone, a Bernoulli regression modeling displaying the country’s expectancy trends against time, (noting as health care, socio-economic factors, and overall lifestyle advancements increased), the proportion of average life expectancy above 62 also increased. Finally, contrasting countries based on distance from equator, the Bernoulli model shows countries located closer to the equator have a lower life expectancy which may be due to climate, environment, and disease. The study offers valuable insights on the impact of economic strength, lifestyle advancements, and environmental factors on life expectancies. 

# Introduction

Across the globe, it is apparent that most of the human population is living much longer than in the past. In 1900 the average life expectancy in the US was 32 years old and in 2021, the global average life expectancy was drastically doubled to over 71 (Dattani). This increase is predominately due to advancements in health care, economic growth, education, living conditions, and poverty reduction. Due to this significant shift in behavior, we decided to analyze a data set dedicated to life expectancy data dating back for more than a century. From this data set there are some key insights we are looking to find:
The change in the proportion of a country’s population whose average life expectancy is greater than 62 overtime when focusing on the 7 major worldwide economic players.
The change in the proportion of average life expectancies above 62 in the United States alone over the years.
Comparing the proportion of average life expectancies above 62 in countries near the equator vs far in effort to see the significance of climate/environmental factors on life expectancy.


# Data and Methods

Describe the data you used in your analysis, including the source, characteristics, and any pre-processing or cleaning steps you performed. 


```{r}
le <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-12-05/life_expectancy.csv')
le_different_ages <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-12-05/life_expectancy_different_ages.csv')

```
```{r}
working_dir <- here::here()

colnames(le)[4] <- "LifeExpectancy"


colnames(le_different_ages)[4:9] <- c("LifeExpectancy0", "LifeExpectancy10", "LifeExpectancy25","LifeExpectancy45", "LifeExpectancy65", "LifeExpectancy80")


```

```{r}
# Add a new column named 'Past62' indicating whether individuals are expected to live past 62
le$Past62 <- ifelse(le$LifeExpectancy > 62, 1, 0)

# List of countries to include
countries_to_include <- c("United States", "China", "Japan", "Germany", "India", "United Kingdom", "France")

# Filter the dataset to include only the specified countries
le_filtered <- le %>% filter(Entity %in% countries_to_include)
```

## INSIGHT 1- TOP 7 GDP COUNTRIES

We define as outcome the presence/absence of a population whose average life expectancy is above 62 for each country and denote the observed values as $y_i$ with $i = 1, \ldots, n$ with $n = 7$. Let $y_i = 1$ indicate average life expectancy $> 62$ and $0$ otherwise.  

We assume that each $y_i$ is a realization of a random variables $Y_i \sim \mbox{Bernoulli}(p_i)$ independently, and model an average life expectancy above 62 for each country using the following logistic regression:

 ---Idk about beta 8 this graph might just be for facotr variables or should we include time? 

$$
\begin{aligned}
  \mbox{logit}(p_i) = & \beta_0 + \\ 
                    & \beta_1 \times \text{I(color == United States)}_i  \\
                   & \beta_2 \times \text{I(color == China)}_i \\
                   & \beta_3 \times \text{I(color == Germnay)}_i \\
                   & \beta_4 \times \text{I(color == Japan)}_i \\
                   & \beta_5 \times \text{I(color == India)}_i \\
                   & \beta_6 \times \text{I(color == United Kingdom)}_i \\
                   & \beta_7 \times \text{I(color == France)}_i \\
                   & \beta_8  \times \text{I(width)}_i
\end{aligned}
$$ {#eq-crab-model}

where $\mbox{I}()$ in Equation 1 indicates an indicator variable, taking value 1 when the condition is true and zero otherwise

#### Figure 1: 

## INSIGHT 2- United States over time Binomial THIS IS WRONG MODEL SET UP ->(N,P)

We define as outcome in the United states where the average life expectancy is above 62 at $year_i$ and denote the observed values as $y_i$ with $i = 1, \ldots, n$ with $n = 100$. Let $y_i = 1$ indicate average life expectancy $> 62$ and $0$ otherwise.  

We assume that each $y_i$ is a realization of a random variables $Y_i \sim \mbox{Bernoulli}(p_i)$ independently, and model an average life expectancy above 62 for each year using the following logistic regression:

## INSIGHT 3 - Countries close and far from equator

# Results

## Insight 1- THIS ENTIRE SECTION NEEDS TO BE FIXED- YEAR AND COUNTRY OR JUST YEAR OR JUST COUNTRY?? ALSO WHICH YR AGGREGATION- 5 OR 10?

```{r}
############# I'm just copying what was done in the beetles slide deck/ HW 2.

# scatterplot of past62 vs year
# picked >= 1910 because there aren't any countries with prop >0 until 1930
top_gdp_countries_10 <- le_filtered %>%
  mutate(Decade = as.integer(Year %/% 10) * 10) %>%
  subset(Decade >= 1900) %>%  
  group_by( Decade) %>%
  summarize(proportion_past_62 = mean(Past62))

ggplot(top_gdp_countries_10, aes(x = Decade)) + 
  geom_point(aes(y = proportion_past_62)) +
  labs(title = "Proportion of population surviving to age 62 vs decade", x = "Decade", y= "Proportion")+
  theme_bw()

# also tried with 5 yr increments - DELETE????
top_gdp_countries_5 <- le_filtered %>%
  mutate(Year = as.integer(Year %/% 5) * 5) %>%
  subset(Year >= 1900) %>%
  group_by(Entity, Year) %>%
  summarize(proportion_past_62 = mean(Past62))

ggplot(top_gdp_countries_5, aes(x = Year)) + 
  geom_point(aes(y = proportion_past_62)) 

# did it with gdp instead of time - DELETE???????
top_gdp_countries_GDP <- le_filtered_gdp %>%
  group_by(Entity, GDP) %>%
  summarize(proportion_past_62 = mean(Past62))

ggplot(top_gdp_countries_GDP, aes(x = GDP)) + 
  geom_point(aes(y = proportion_past_62)) 
```
The plot shows the estimated probability of surviving to age 62 versus the decade. We estimate the probability using sample proportions calculated from 10-year increments (left panel) and 5-year increments (right panel). Both plots suggest that the
probability of surviving to age 62 increases as the decade come closer to present day. After the 2000s decade we estimate the probability to be one.

For this portion of the analysis, we will aggregate by decade across the replicates. There is a large number of observations for each decade wich reduces uncertainty of the estimated probability.
```{r}
count(le_filtered, Entity, Decade = as.integer(Year %/% 10) * 10)

count(le_filtered, Decade = as.integer(Year %/% 10) * 10) %>%
  filter(Decade >= 1900)
```


```{r}
# GLM for the proportion of individuals expected to live beyond 62
top_gdp_countries_10_entity <- le_filtered %>%
  mutate(Decade = as.integer(Year %/% 10) * 10) %>%
  subset(Decade >= 1900) %>%  
  group_by(Entity, Decade) %>%
  summarize(proportion_past_62 = mean(Past62))

binomial_model_country <- glm(formula = proportion_past_62 ~ Entity + Decade, data = top_gdp_countries_10_entity, family = binomial)
summary(binomial_model_country)

anova_country <- anova(binomial_model_country, test = "Chisq")
anova_country
```

```{r}
# Interpretation of beta8 and CI
exp(coef(binomial_model_country)[8])
beta_8_hat <- coef(binomial_model_country)[8]
beta_8_hat_se <- sqrt(diag(vcov(binomial_model_country))[8])
beta_8_ci <- beta_8_hat + c(-1,1) * beta_8_hat_se *qnorm(0.05/2, lower.tail = FALSE)
exp(beta_8_ci)
```

###########THIS IS ALL WRONG
Model Fit:
All parameters in the model have p-values that are significantly different from 0. The incredibly small p-values in the analysis of deviance table (a change in deviance of 158.56 on 6 degrees of freedom and 1065.98 on one degree of freedom) indicates that there is strong evidence to reject  the intercept-only model and prefer our logistic regression model with entity and year as covariates. 

Model Interpretation:
The model says that for a one unit increase in year, the log odds of surviving to 62 multiplies by $e ^ \hat{\beta_8} = 5.2539$ with a 95% confidence interval of between [2.12, 13.01].

### model that uses only decade as a covariate
```{r}
binomial_model_yr <- glm(proportion_past_62 ~ Decade, data = top_gdp_countries_10, family = binomial)
summary(binomial_model_yr)

anova_gdp <- anova(binomial_model_yr, test = "Chisq")
anova_gdp
```
Nothing significant??

Trying based on 5 yr aggregation
```{r}
top_gdp_countries_5_entity <- le_filtered %>%
  mutate(Year = as.integer(Year %/% 5) * 5) %>%
  subset(Year >= 1900) %>%  
  group_by(Entity, Year) %>%
  summarize(proportion_past_62 = mean(Past62))

binomial_model_country_5 <- glm(formula = proportion_past_62 ~ Entity + Year, data = top_gdp_countries_5_entity, family = binomial)
summary(binomial_model_country_5)

anova_country <- anova(binomial_model_country_5, test = "Chisq")
anova_country
```

### model that uses only decade as a covariate
```{r}
binomial_model_yr_5 <- glm(proportion_past_62 ~ Year, data = top_gdp_countries_5, family = binomial)
summary(binomial_model_yr_5)

anova_gdp <- anova(binomial_model_yr_5, test = "Chisq")
anova_gdp
```

## Comparison of models- I think we should do by 5yrs and delete 10
############################

Insight 2:
```{r}
us_data <- le_filtered %>%
   filter(Entity == "United States")

us_model <- glm(Past62 ~ Entity, data = us_)
```

########################


To display the model summary in a nice format you can use the `summ()` function from the `jtools` package.
 
Other libraries: 
\begin{itemize}
\item \texttt{xtable}: good if you are familiar with latex (see \href{https://cran.r-project.org/web/packages/xtable/vignettes/xtableGallery.pdf}{xtable documentation} for examples)
\item \texttt{gtable}, implements a ``grammar of table'' idea (see \url{https://gt.rstudio.com} for documentation)
\end{itemize}

In this section, discuss and interpret your results. Explain the implications and significance of your findings, and relate them to your research question and existing literature or theories.

# Conclusion

Summarize your main findings and conclusions in this section. Highlight the key takeaways and contributions of your analysis, and provide recommendations or suggestions for future research or practical applications based on your results.

### References

::: {#refs}
:::

# Appendix (Optional)

If you want to include your R code as an appendix, you can create a new code chunk and set `#| echo: true` to show the code and `#| eval: false` to avoid that to be run. You can also provide scripts separately as supplementary material.

```{r}
#| echo: true
#| eval: false

# Your code here
```


